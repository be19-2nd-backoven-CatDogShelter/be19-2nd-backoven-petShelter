<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.backoven.catdogshelter.domain.volunteer.query.mapper.VolunteerPostQueryMapper">

    <!-- 봉사활동 후기 게시글 전체 목록 조회 -->
    <resultMap id="allMap" type="com.backoven.catdogshelter.domain.volunteer.query.dto.VolunteerPostListDTO">
        <id property="id"        column="id"/>
        <result property="title"     column="title"/>
        <result property="userName"    column="userName"/>
        <result property="createdAt" column="createdAt"/>
        <result property="view"      column="view"/>
        <result property="likeCount" column="likeCount"/>
    </resultMap>
    <select id="selectVolunteerPostList" resultMap="allMap"
            resultType="com.backoven.catdogshelter.domain.volunteer.query.dto.VolunteerPostListDTO">
        SELECT
               vp.id                          AS id
             , vp.title                       AS title
             , u.user_name                    AS userName
             , vp.created_at                  AS createdAt
             , vp.view                        AS view
             , ifnull(lc.likes, 0)            AS likeCount
          FROM volunteerpost AS vp
          JOIN volunteerassociationapplicationdetails AS vaad
            ON vaad.id = vp.volappdetail_id
          JOIN volunteerassociation AS va
            ON va.id = vaad.volunteer_id
          JOIN user AS u
            ON u.user_id = vaad.user_id
          LEFT JOIN (SELECT
                            post_id
                          , COUNT(*) AS likes
                       FROM volunteerpostliked
                      GROUP BY post_id
                    ) AS lc ON lc.post_id = vp.id
         WHERE vp.is_blinded = FALSE
           AND vp.is_deleted = FALSE
           AND vaad.status = TRUE
           AND va.deadline = TRUE
           AND va.is_end = TRUE
<<<<<<< HEAD
         ORDER BY vp.id DESC
=======
         ORDER BY vp.id DESC;
>>>>>>> 33f796932cfb84fa1aacf92a4c46f369f22dd1ce
    </select>

    <!-- 봉사후기 상세조회 -->
    <resultMap id="vpMap"
               type="com.backoven.catdogshelter.domain.volunteer.query.dto.VolunteerPostDTO">
        <id     property="id"         column="id"/>
        <result property="title"      column="title"/>
        <result property="content"    column="content"/>
        <result property="createdAt"  column="created_at"/>
        <result property="updatedAt"  column="updated_at"/>
        <result property="writerName" column="writer_name"/>
        <result property="view"       column="view"/>
        <result property="likeCount"  column="like_count"/>
        <collection property="comments" select="selectVolunteerPostComments" column="id"
                    ofType="com.backoven.catdogshelter.domain.volunteer.query.dto.VolunteerPostCommentDTO"/>
        <collection property="files" select="selectVolunteerPostFiles" column="id"
                    ofType="com.backoven.catdogshelter.domain.volunteer.query.dto.VolunteerPostFileDTO"/>
    </resultMap>
    <select id="selectVolunteerPost" parameterType="_int" resultMap="vpMap">
        SELECT
               vp.id
             , vp.title
             , vp.content
             , vp.created_at
             , vp.updated_at
             , vp.view
             , u.user_name                      AS writer_name
             , IFNULL(lc.like_count, 0)         AS like_count
          FROM volunteerPost vp
          JOIN volunteerAssociationApplicationDetails vaad
            ON vaad.id = vp.volappdetail_id
          JOIN volunteerAssociation va
            ON va.id = vaad.volunteer_id
          JOIN user u
            ON u.user_id = vaad.user_id
          LEFT JOIN (SELECT
                            post_id
                          , COUNT(*) AS like_count
                       FROM volunteerPostLiked
                      GROUP BY post_id) lc
            ON lc.post_id = vp.id
         WHERE vp.id = #{id}
           AND vp.is_deleted = FALSE
           AND vp.is_blinded = FALSE
           AND vaad.status  = TRUE
           AND va.deadline  = TRUE
           AND va.is_end    = TRUE
    </select>

    <!-- 댓글 목록 (XOR: user_id 또는 head_id) -->
    <resultMap id="vpcMap"
               type="com.backoven.catdogshelter.domain.volunteer.query.dto.VolunteerPostCommentDTO">
        <id     property="id"         column="id"/>
        <result property="content"    column="content"/>
        <result property="createdAt"  column="created_at"/>
        <result property="commentor"  column="commentor"/>
    </resultMap>
    <select id="selectVolunteerPostComments"
            parameterType="_int"
            resultMap="vpcMap">
        SELECT
               vpc.id
             , vpc.content
             , vpc.created_at
             , COALESCE(u.user_name, sh.ceo_name) AS commentor
          FROM volunteerPostComment vpc
          LEFT JOIN user         u  ON u.user_id  = vpc.user_id
          LEFT JOIN shelter_head sh ON sh.head_id = vpc.head_id
         WHERE vpc.post_id   = #{id}
           AND vpc.is_deleted = FALSE
           AND vpc.is_blinded = FALSE
           AND (vpc.user_id IS NOT NULL OR vpc.head_id IS NOT NULL)
         ORDER BY vpc.created_at DESC
    </select>

    <!-- 파일 목록 (게시글 1:N) -->
    <resultMap id="vpfMap"
               type="com.backoven.catdogshelter.domain.volunteer.query.dto.VolunteerPostFileDTO">
        <result property="rename" column="file_rename"/>
        <result property="path"   column="file_path"/>
    </resultMap>
    <select id="selectVolunteerPostFiles"
            parameterType="_int"
            resultMap="vpfMap">
        SELECT
               file_rename
             , file_path
          FROM volunteerPostFiles
         WHERE post_id = #{id}
         ORDER BY uploaded_at ASC, id ASC
    </select>

    <!-- 제목, 내용, 작성자에 검색어 포함한 게시글 목록 -->
    <resultMap id="searchMap" type="com.backoven.catdogshelter.domain.volunteer.query.dto.VolunteerPostListDTO">
        <id property="id"        column="id"/>
        <result property="title"     column="title"/>
        <result property="userName"    column="userName"/>
        <result property="createdAt" column="createdAt"/>
        <result property="view"      column="view"/>
        <result property="likeCount" column="likeCount"/>
    </resultMap>
    <select id="selectVolunteerPostsListByKeyword" resultMap="searchMap" parameterType="string"
            resultType="com.backoven.catdogshelter.domain.volunteer.query.dto.VolunteerPostListDTO">
        SELECT
               vp.id                          AS id
             , vp.title                       AS title
             , u.user_name                    AS userName
             , vp.created_at                  AS createdAt
             , vp.view                        AS view
             , IFNULL(lc.likes, 0)            AS likeCount
          FROM volunteerpost AS vp
          JOIN volunteerassociationapplicationdetails AS vaad
            ON vaad.id = vp.volappdetail_id
          JOIN volunteerassociation AS va
            ON va.id = vaad.volunteer_id
          JOIN user AS u
            ON u.user_id = vaad.user_id
          LEFT JOIN (SELECT
                            post_id, COUNT(*) AS likes
                       FROM volunteerpostliked
                      GROUP BY post_id) AS lc
            ON lc.post_id = vp.id
         WHERE vp.is_blinded = FALSE
           AND vp.is_deleted = FALSE
           AND vaad.status = TRUE
           AND va.deadline = TRUE
           AND va.is_end = TRUE

        <!-- keyword가 있을 때만 추가 조건 적용 -->
        <if test="keyword != null and keyword != ''">
            AND (vp.title LIKE CONCAT('%', #{keyword}, '%')
             OR  vp.content LIKE CONCAT('%', #{keyword}, '%')
             OR  u.user_name LIKE CONCAT('%', #{keyword}, '%'))
        </if>

        ORDER BY vp.id DESC
    </select>
<<<<<<< HEAD

    <!-- 봉사후기 조회수순으로 목록 조회 -->
    <resultMap id="viewListMap" type="com.backoven.catdogshelter.domain.volunteer.query.dto.VolunteerPostListDTO">
        <id property="id"        column="id"/>
        <result property="title"     column="title"/>
        <result property="userName"    column="userName"/>
        <result property="createdAt" column="createdAt"/>
        <result property="view"      column="view"/>
        <result property="likeCount" column="likeCount"/>
    </resultMap>
    <select id="selectVolunteerPostsByView" resultMap="viewListMap"
            resultType="com.backoven.catdogshelter.domain.volunteer.query.dto.VolunteerPostListDTO">
        SELECT
               vp.id                          AS id
             , vp.title                       AS title
             , u.user_name                    AS userName
             , vp.created_at                  AS createdAt
             , vp.view                        AS view
             , ifnull(lc.likes, 0)            AS likeCount
          FROM volunteerpost AS vp
          JOIN volunteerassociationapplicationdetails AS vaad
            ON vaad.id = vp.volappdetail_id
          JOIN volunteerassociation AS va
            ON va.id = vaad.volunteer_id
          JOIN user AS u
            ON u.user_id = vaad.user_id
          LEFT JOIN (SELECT
                            post_id
                          , COUNT(*) AS likes
                       FROM volunteerpostliked
                      GROUP BY post_id) AS lc ON lc.post_id = vp.id
         WHERE vp.is_blinded = FALSE
           AND vp.is_deleted = FALSE
           AND vaad.status = TRUE
           AND va.deadline = TRUE
           AND va.is_end = TRUE
         ORDER BY vp.view DESC
    </select>

    <!-- 봉사후기 추천수순으로 목록 조회 -->
    <resultMap id="likeListMap" type="com.backoven.catdogshelter.domain.volunteer.query.dto.VolunteerPostListDTO">
        <id property="id"        column="id"/>
        <result property="title"     column="title"/>
        <result property="userName"    column="userName"/>
        <result property="createdAt" column="createdAt"/>
        <result property="view"      column="view"/>
        <result property="likeCount" column="likeCount"/>
    </resultMap>
    <select id="selectVolunteerPostsByLiked" resultMap="likeListMap"
            resultType="com.backoven.catdogshelter.domain.volunteer.query.dto.VolunteerPostListDTO">
        SELECT
               vp.id                          AS id
             , vp.title                       AS title
             , u.user_name                    AS userName
             , vp.created_at                  AS createdAt
             , vp.view                        AS view
             , ifnull(lc.likes, 0)            AS likeCount
          FROM volunteerpost AS vp
          JOIN volunteerassociationapplicationdetails AS vaad
            ON vaad.id = vp.volappdetail_id
          JOIN volunteerassociation AS va
            ON va.id = vaad.volunteer_id
          JOIN user AS u
            ON u.user_id = vaad.user_id
          LEFT JOIN (SELECT
                            post_id
                          , COUNT(*) AS likes
                       FROM volunteerpostliked
                      GROUP BY post_id) AS lc ON lc.post_id = vp.id
         WHERE vp.is_blinded = FALSE
           AND vp.is_deleted = FALSE
           AND vaad.status = TRUE
           AND va.deadline = TRUE
           AND va.is_end = TRUE
         ORDER BY likeCount DESC
    </select>
=======
>>>>>>> 33f796932cfb84fa1aacf92a4c46f369f22dd1ce
</mapper>
