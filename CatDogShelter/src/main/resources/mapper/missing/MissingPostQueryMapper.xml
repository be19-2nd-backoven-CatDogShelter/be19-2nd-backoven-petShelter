<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.backoven.catdogshelter.domain.missing.query.mapper.MissingPostQueryMapper">

    <!-- REQ-021 게시글 목록 조회 -->
    <select id="searchPosts" resultType="com.backoven.catdogshelter.domain.missing.query.dto.MissingPostQueryDTO">
        SELECT p.id, p.title, p.content, p.created_at, p.view,
        u.user_name AS userName
        FROM missingPost p
        LEFT JOIN user u ON p.user_id = u.user_id
        WHERE p.is_deleted = FALSE
        <if test="keyword != null and keyword != ''">
            AND (p.title LIKE CONCAT('%', #{keyword}, '%')
            OR p.content LIKE CONCAT('%', #{keyword}, '%')
            OR u.user_name LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        ORDER BY p.created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- REQ-029 인기 게시글 -->
    <select id="findPopularPosts" resultType="com.backoven.catdogshelter.domain.missing.query.dto.MissingPostQueryDTO">
        SELECT p.id, p.title, p.view, COUNT(l.id) AS likeCount
        FROM missingPost p
                 LEFT JOIN missingPostLiked l ON p.id = l.post_id
        WHERE p.is_deleted = FALSE
        GROUP BY p.id, p.title, p.view
        ORDER BY (p.view + COUNT(l.id)) DESC
            LIMIT #{limit}
    </select>

    <!-- REQ-030 최신 게시글 -->
    <select id="findLatestPosts" resultType="com.backoven.catdogshelter.domain.missing.query.dto.MissingPostQueryDTO">
        SELECT p.id, p.title, p.created_at, p.view
        FROM missingPost p
        WHERE p.is_deleted = FALSE
        ORDER BY p.created_at DESC
            LIMIT #{limit}
    </select>

    <!-- REQ-028 조회수 증가 -->
    <update id="increaseView">
        UPDATE missingPost
        SET view = view + 1
        WHERE id = #{id}
    </update>
<!--게시글 조회-->
    <select id="selectPostById" parameterType="long" resultType="com.backoven.catdogshelter.domain.missing.query.dto.MissingPostQueryDTO">
        SELECT
            id,
            title,
            content,
            created_at,
            updated_at,
            view,
            head_id
        FROM missingPost
        WHERE id = #{id}
    </select>

</mapper>